> [!IMPORTANT]
> **AIアシスタントへの指示**:
> 開発を進める際は、まず `docs/要件定義.md` と `docs/開発フロー.md` を読み込み、プロジェクトの全容と現在の進捗ステップを把握してください。
> 各ドキュメント（企画書、要件定義、UX設計、サービス検討、開発フロー）は互いに整合性が取れるように運用してください。仕様の変更を独断で行わず、必ず提案と確認を経てから実行してください。
> 🛑 マークがある箇所は、人間の操作や確認が必要なタイミングです。必ず作業を中断し、ユーザーに指示を仰いでください。

# LINE audiomemo 技術要件定義書

本ドキュメントでは、「LINE audiomemo」のシステム構成、技術選定、およびディレクトリ構造について定義します。
保守性と拡張性を高めるため、TypeScriptを採用し、クリーンアーキテクチャの考え方を取り入れた設計を目指します。

## 1. 技術スタック
- **言語**: TypeScript (全レイヤー)
- **バックエンド**: Cloudflare Workers
- **データベース**: Cloudflare Workers KV & D1 (ユーザー設定・トークン管理)
- **AIエンジン**: Google Gemini 1.5 Flash (Google AI Studio API)
- **外部連携**: 
    - LINE Messaging API
    - Webhook (HTTPS POST / iPaaS連携)
- **暗号化**: Web Crypto API (RSA-OAEP, AES-GCM)

---

## 2. ディレクトリ構成（モノレポ構成想定）
クリーンアーキテクチャを意識し、関心の分離を徹底します。

```text
/
├── packages/
│   ├── backend/                # Cloudflare Workers
│   │   ├── src/
│   │   │   ├── core/           # ビジネスロジック・共通型・バリデーション
│   │   │   │   ├── journal.ts  # ジャーナル処理のメインロジック
│   │   │   │   ├── crypto.ts   # 暗号化ユーティリティ
│   │   │   │   └── types.ts    # ドメイン関連の型定義
│   │   │   ├── services/       # 外部連携（実装詳細を隠蔽）
│   │   │   │   ├── gemini.ts   # Google Gemini 1.5 API 連携
│   │   │   │   ├── kv.ts       # Cloudflare KV 操作
│   │   │   │   └── line.ts     # LINE Messaging API 操作
│   │   │   ├── handlers/       # エントリポイント（Webhook/APIハンドラ）
│   │   │   │   ├── webhook.ts  # LINE Webhook 受信処理
│   │   │   │   └── api.ts      # Obsidian向けデータ取得API（未同期取得/Ack）
│   │   │   └── index.ts        # 全体のルーティングとエントリポイント
│   │   ├── wrangler.toml
│   │   └── package.json
│   │
│   └── obsidian-plugin/        # Obsidian Plugin
│       ├── src/
│       │   ├── api.ts          # Backend API クライアント (Sync Logic)
│       │   ├── crypto.ts       # 復号・鍵管理
│       │   ├── ui.ts           # 設定画面 (Vault ID, User ID, Sync Interval, Folder Path)
│       │   └── main.ts         # エントリポイント (Auto Sync Timer)
│       └── manifest.json
│
└── shared/                     # backend と plugin で共有する型
    └── constants.ts
```

---

## 3. レイヤー定義（シンプル版）

### core/ (ビジネスロジック)
- アプリケーションの「心臓部」。
- **連携フロー**:
    - LINE上でユーザーが「ID」と発言 → ボットが `userId` を返信。
    - Obsidian上でユーザーが `userId` を入力 → サーバーに登録リクエストを送信。
    - サーバー側で `userId` と `vaultId` の紐付けを確定。
- **ジャーナルフロー (事前確認あり)**:
    - 音声を受信し解析（文字起こし+要約）。
    - 要約結果をユーザーに提示し、`pending_session` 状態として KV に保存。
    - ユーザーが「送信」を選択した場合、暗号化して保存/外部配信。
    - 「キャンセル」時は一時データを破棄。

### services/ (外部連携)
- 各外部サービスの SDK や API 呼び出しの具体的な実装を閉じ込めます。
- `webhook.ts`: ユーザー指定の Webhook URL への POST 処理（JSON形式）。
      - **入力検証**: ユーザーが `/webhook` とだけ入力したり、不正な形式な場合は、正しい利用方法を示すヘルプメッセージを表示する。

### handlers/ (インターフェース)
- HTTPリクエストを受けて、適切な `core` のロジックへ橋渡しをします。
- `auth.ts`: 必要に応じて Webhook 接続テスト等のエンドポイントを提供。

---

## 4. セキュリティ要件
- **End-to-End Encryption (E2EE)**:
  - クライアント（Obsidian）で生成した公開鍵をバックエンドに登録。
  - バックエンドは、Geminiで要約した結果をその公開鍵で暗号化（RSA-OAEP + AES-GCM）して保存。
  - 秘密鍵は Obsidian 側の `local storage` または `vault` 内にのみ保持し、サーバーへは絶対に送らない。
- **署名検証**:
  - LINE からの Webhook リクエストに対し、`x-line-signature` ヘッダーを用いた署名検証を必須とする。

---

## 5. データモデル案 (KV & D1設計)
### KV (一時データ・キャッシュ)
- `active_vault:{lineUserId}` -> `{ vaultId }` (現在アクティブな送信先Vault)
- `pending_session:{lineUserId}` -> `{ currentSummary, timestamp }` (送信待ちの一時ステート)
- `oauth_state:{state}` -> `{ lineUserId, provider }` (OAuthフロー用の一時ステート)

### D1 (永続化データ・トークン)
**WebhookConfigs Table** (Webhook設定管理)

| Column        | Type      | Description        |
| :------------ | :-------- | :----------------- |
| line_user_id  | TEXT (PK) | LINEユーザーID         |
| webhook_url   | TEXT      | 送信先 Webhook URL    |
| secret_token  | TEXT      | Authorizationヘッダー等に使用する秘密鍵 (任意) |
| config        | JSON      | 送信フォーマット設定など    |

**UserConfigs Table** (ユーザー設定管理)

| Column        | Type      | Description        |
| :------------ | :-------- | :----------------- |
| line_user_id  | TEXT (PK) | LINEユーザーID         |
| confirm_mode  | INTEGER   | 事前確認フラグ (0: OFF, 1: ON(default)) |
| prompt_mode   | TEXT      | 'diary', 'todo', 'memo', 'brainstorm', 'custom' |
| custom_prompt | TEXT      | ユーザー定義のカスタムプロンプト (NULL許容) |

## 6. プロンプト設計 (プリセット)
- **Diary (日記)**: 感情重視、共感的、時系列整理。
- **TODO**: アクション動詞抽出、期限抽出、リスト形式。
- **Memo (気づき)**: 要点抽出、短文、Markdown箇条書き。
- **Brainstorm (壁打ち)**: 論点整理、構造化、ネクストアクションや考察の提案。

## 6. Obsidianプラグイン機能要件
- **設定項目**:
    - **基本設定**:
        - LINE User ID / Vault ID
        - 保存先フォルダパス (例: `LINE_Notes/`)
    - **ファイル整理**:
        - `Group messages by date`: ONなら1日1ファイル、OFFなら1メッセージ1ファイル。
        - ファイル名テンプレート (例: `{date}_journal.md` / `{date}-{messageId}.md`)
        - コンテンツテンプレート (例: `##### {time}\n{text}`)
    - **同期設定**:
        - `Auto sync`: ON/OFF
        - `Sync on startup`: ON/OFF
        - `Sync interval`: 1〜5時間 (選択式)
    - **UI機能**:
        - **Sync Now ボタン**: リボンアイコンまたはコマンドパレットから手動で即時同期を実行する機能。
- **同期ロジック (Solid Sync)**:
    - **Fetch**: `GET /messages/{vaultId}/{userId}` で未同期データを取得。
    - **Process**:
        - ローカル秘密鍵で復号 (E2EE)。
        - 設定(`groupMessagesByDate`)に基づき、日次ファイルへの追記 or 個別ファイルの作成を分岐。
        - テンプレートエンジンによるファイル名・本文の整形（`{date}`, `{time}`, `{text}` 等の置換）。
    - **Ack**: ファイル書き込み成功後、`POST /messages/update-sync-status` で同期済みIDを送信。
    - **Retry**: 通信エラー時は指数バックオフ (Exponential Backoff) を用いて最大3回まで再試行する。

---

## 7. フェーズ別実装ロードマップ (技術視点)
1. **基盤構築**: Cloudflare Workers のセットアップ、LINE Webhook 署名検証の実装。
2. **AI連携**: LINE から音声ファイルを取得、一時保存、Gemini API への送信とレスポンス取得。
3. **プラグイン開発**: Obsidian から API を叩き、メッセージ一覧を取得するプロトタイプ作成。
4. **暗号化実装**: Web Crypto による暗号化・復号処理の統合。

---

## 8. 非機能要件・品質基準
- **完全日本語対応 (Localization)**:
    - ObsidianプラグインおよびLINE Botの全UI/UX（メッセージ、ボタン、設定画面、エラー表示など）は、**全て日本語**で実装すること。英語の表記が残らないようにする。
- **コード品質 (Refactoring)**:
    - ソースコード内のコメントアウトは、可読性を高めるため**全て日本語**で記述すること。既存の英語コメントも日本語にリファクタリングする。
