# 統合テスト手順書 (Integration Test Procedure)

このドキュメントは、LINE Audio Summarizer の全機能が正しく動作することを確認するための手順書です。

## 1. 事前準備 (Backend & Plugin Setup)
- [ ] **Backend デプロイ**: `npm run deploy -w packages/backend` が最新の状態で行われていること。
- [ ] **Plugin ビルド**: `npm run build` (ルートで `main.js` が更新されていること)。
- [ ] **Plugin 読み込み**: Obsidian をリロードし、Community Plugins に "LINE Audio Summarizer" が表示され、有効化されていること。

## 2. 初期設定フロー (Registration)
1.  **User ID 取得**:
    - LINE Bot に向かって `/id` と送信する。
    - User ID (例: `Uabcdef...`) が返信されることを確認。
2.  **Obsidian 設定**:
    - Obsidian の設定画面 -> `LINE Audio Summarizer` を開く。
    - `LINE User ID` 欄に上記IDを入力。
    - `鍵を生成して登録` ボタンをクリック。
    - 「成功」のダイアログが表示され、ステータスが「✅ 鍵ペア: 生成済み」になることを確認。
3.  **Backend データ確認 (Optional)**:
    - 開発者が `wrangler d1 execute DB --command "SELECT * FROM PublicKeys"` 等でデータを確認できる場合、該当ユーザーのキーが登録されているか確認。

## 3. 音声要約 & 暗号化フロー (E2EE Flow)
1.  **音声送信**:
    - LINE Bot に 10秒程度のボイスメッセージを送信。
    - 「要約中...」のような待機状態（現在は即レスポンスはないため、裏で処理が進む待機）。
    - **期待値**: 数秒〜十数秒後に「要約が作成されました」という Flex Message が届く。
2.  **要約内容確認**:
    - Flex Message 内に要約テキストが表示されているか確認。
    - 違和感のない日本語か確認。
3.  **キャンセル動作 (破棄)**:
    - 「破棄」ボタンをタップ。
    - **期待値**: 「破棄しました。」と返信され、何も保存されない。
4.  **保存動作 (暗号化)**:
    - 再度、同じ（または別の）音声を送信。
    - 要約 Flex Message が届いたら、「**保存 (暗号化)**」ボタンをタップ。
    - **期待値**: 「Inboxに保存しました (暗号化済み)。」と返信される。

## 4. 同期 & 復号フロー (Sync & Decrypt)
1.  **同期実行**:
    - Obsidian のリボンアイコン（更新マーク）をクリック。
    - **期待値**: 「Inboxを確認中...」 -> 「X 件のメッセージを受信しました」 -> 「X 件のメモを保存しました！」の通知が表示される。
2.  **ファイル確認**:
    - ファイルエクスプローラーに `VoiceSummaries` フォルダが作成されているか確認。
    - 中に `YYYY-MM-DD-HHmm.md` というファイルができているか確認。
3.  **内容確認**:
    - ファイルを開き、LINEで確認した要約と同じ文章が（復号されて）記載されているか確認。

## 5. エラーハンドリング確認
1.  **設定未完了での保存**:
    - (もし可能なら) Obsidianで鍵登録をしていない別のLINEユーザーから音声を送り、「保存」を押す。
    - **期待値**: 「公開鍵が見つかりません」等のエラーメッセージがLINEに返る。

## 6. UI/UX チェック
- [ ] LINE のメッセージやボタンの日本語は自然か？
- [ ] Obsidian の設定画面の案内は分かりやすいか？
- [ ] 同期時の通知は適切か？
