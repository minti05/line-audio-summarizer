> [!IMPORTANT]
> **AIアシスタントへの指示**:
> 開発を進める際は、まず本ドキュメント（`docs/開発フロー.md`）と `docs/要件定義.md` を読み込み、現在の進捗ステップを確認してください。
> 各ステップ完了ごとに、必ず `git commit` を行ってください。
> 仕様の変更を独断で行わず、必ず提案と確認を経てから実行してください。
> 🛑 マークがある箇所は、人間の操作や確認が必要なタイミングです。必ず作業を中断し、ユーザーに指示を仰いでください。

# 開発フロー

このドキュメントは、`line-audio-summarizer` の開発を進めるためのステップバイステップガイドです。
`docs/要件定義.md` に記載されたモノレポ構成とクリーンアーキテクチャに基づき、Backend (Cloudflare Workers) と Obsidian Plugin の両方を開発します。

---

## Phase 0: プロジェクト構成の再構築 (モノレポ化)

現在のディレクトリ構成は Obsidian プラグイン単体のものになっています。`docs/要件定義.md` に従い、モノレポ構成へ移行します。

- [x] **ディレクトリ構造の変更**
    - [x] ルート直下のプラグイン関連ファイル (`src/`, `main.ts`, `manifest.json`, `styles.css`, `esbuild.config.mjs` 等) を `packages/obsidian-plugin/` へ移動。
    - [x] `packages/backend/` ディレクトリを作成。
    - [x] `shared/` ディレクトリを作成。
    - [x] ルートに `package.json` (ワークスペース定義用) を作成。
    - 参照: `docs/要件定義.md` - ## 2. ディレクトリ構成
- [x] **Cloudflare Workers の初期化**
    - [x] `packages/backend/` 内で Wrangler を設定 (`wrangler.init` 相当)。
    - [x] `pnpm` ワークスペースの設定 (推奨) または `npm` ワークスペースの設定。

---

## Phase 1: Backend 基盤構築 & LINE Messaging API 連携

Cloudflare Workers 上で LINE Bot の土台を作成します。

- [x] **Backend 環境設定**
    - [x] `packages/backend/wrangler.toml` の設定 (KV, D1 のバインディング定義)。
    - [x] `packages/backend/src/index.ts` (エントリポイント) の作成。
- [x] **LINE Webhook 受け口の実装**
    - [x] `handlers/webhook.ts` の実装。
    - [x] 署名検証ロジック (`x-line-signature`) の実装。セキュリティ必須項目。
    - 参照: `docs/要件定義.md` - ## 4. セキュリティ要件
- [x] **デプロイとWebhook URLの確認**
    - [x] `wrangler deploy` (または開発用トンネル) で公開 URL を発行。
    - 🛑 **【人間作業】 LINE Developers コンソール設定**
        - 発行された Webhook URL を LINE Developers コンソールに入力する。
        - Webhook の「利用する」を ON にする。
        - Channel Secret を環境変数 (`wrangler secret put`) に設定する。
- [x] **疎通確認 (Echo Bot)**
    - [x] LINE からメッセージを送り、ログ (`wrangler tail`) または簡単な応答が返るか確認。
    - 🛑 **【人間作業】** 実機(LINEアプリ)でボットにメッセージを送り、既読/応答を確認する。

---

## Phase 2: Gemini API 連携 & 音声処理

音声ファイルを受け取り、Gemini で要約するフローを実装します。

- [ ] **Gemini API クライアント実装**
    - [ ] `services/gemini.ts` の作成。Google AI Studio API を叩く実装。
    - [ ] プロンプトテンプレートの実装 (`core/prompts.ts` 等)。
    - 参照: `docs/要件定義.md` - ## 6. プロンプト設計
- [ ] **LINE 音声ファイルの取得**
    - [ ] `services/line.ts` に `getContent` (音声データ取得) 実装。
    - [ ] 取得したバイナリデータを Gemini API へ送信できる形式に変換。
- [ ] **要約フローの実装 (Core)**
    - [ ] 音声メッセージ受信 → 音声取得 → Gemini 要約 → 要約結果を返信 という一連の流れを実装。
    - 🛑 **【人間作業】** LINE でボイスメッセージを送り、要約が返ってくるかテストする。

---

## Phase 3: データ永続化 & User/Vault 紐付け

ユーザーごとの設定と Obsidian Vault との紐付けロジックを実装します。

- [ ] **データベース (D1) 設計 & マイグレーション**
    - [ ] `UserConfigs` テーブル作成 SQL 作成 & 適用。
    - [ ] `WebhookConfigs` テーブル作成 SQL 作成 & 適用。
    - 参照: `docs/要件定義.md` - ## 5. データモデル案
- [ ] **登録フロー実装**
    - [ ] LINE で `/id` コマンド → ユーザーID返却。
    - [ ] Obsidian からのリクエストを受け付ける API エンドポイント `handlers/api.ts` 作成。
    - [ ] KV を利用した一時的な `active_vault` 管理の実装。
- [ ] **Webhook 配信機能の実装**
    - [ ] `services/webhook.ts` の作成 (指定URLへのPOST処理)。
    - [ ] `/webhook` コマンドによるURL登録ロジックの実装。

---

## Phase 4: 暗号化 (E2EE) & Backend 仕上げ

セキュリティ要件に基づく暗号化処理を実装します。

- [ ] **Shared Types 定義**
    - [ ] `shared/types.ts` に API リクエスト/レスポンス型を定義。
- [ ] **暗号化ロジック (Backend)**
    - [ ] 公開鍵登録 API の実装。
    - [ ] 要約結果を保存する際、ユーザーの公開鍵で暗号化する処理の実装。
    - 参照: `docs/要件定義.md` - ## 4. セキュリティ要件

---

## Phase 5: Obsidian Plugin 多機能化

Obsidian プラグイン側で API と連携し、ノートを作成する機能を実装します。

- [ ] **クライアントサイド鍵管理**
    - [ ] Web Crypto API を用いた RSA 鍵ペア生成の実装。
    - [ ] 秘密鍵の Obsidian 内部 (非同期同期フォルダ等) への保存。
- [ ] **設定画面 UI (Settings Tab)**
    - [ ] LINE User ID 入力欄。
    - [ ] 鍵ペア生成 & 公開鍵送信ボタン。
    - [ ] 同期設定 (自動/手動, 間隔)。
    - 参照: `docs/要件定義.md` - ## 7. Obsidianプラグイン機能要件
- [ ] **同期ロジック (Sync)**
    - [ ] `Sync Now` コマンドの実装。
    - [ ] API から暗号化データを取得 (fetch)。
    - [ ] 秘密鍵での復号 (decrypt)。
- [ ] **ファイル保存ロジック**
    - [ ] 設定 (`Group messages by date`) に基づくファイル作成/追記処理。
    - [ ] テンプレート置換処理。

---

## Phase 6: 統合テスト & UI/UX 改善

- [ ] **エンドツーエンドテスト**
    - [ ] LINE で音声送信 → "確認待ち" ステート (KV) → LINE で「送信」ボタン → Backend で暗号化・保存 → Obsidian で同期 → ノート生成。
    - �� **【人間作業】** 全体フローを通して実施し、UX上の違和感がないか確認 (レスポンス速度、メッセージ内容など)。
- [ ] **事前確認 (Pre-confirmation) 機能**
    - [ ] 要約結果をユーザーに返し、「送信」「キャンセル」を選択させる Flex Message 実装。
    - [ ] KV を利用したセッション管理。

---

## Phase 7: リリース準備

- [ ] **本番環境デプロイ**
    - [ ] Cloudflare Workers 本番デプロイ。
    - 🛑 **【人間作業】** LINE Developers で本番用 Webhook URL に切り替え。
- [ ] **Plugin リリースビルド**
    - [ ] `manifest.json` のバージョン更新。
    - [ ] `npm run build` で `main.js` 生成。
