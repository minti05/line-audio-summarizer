> [!IMPORTANT]
> **AIアシスタントへの指示**:
> 開発を進める際は、まず \`docs/要件定義.md\` と \`docs/開発フロー.md\` を読み込み、プロジェクトの全容と現在の進捗ステップを把握してください。
> 各ドキュメント（企画書、要件定義、UX設計、サービス検討、開発フロー）は互いに整合性が取れるように運用してください。仕様の変更を独断で行わず、必ず提案と確認を経てから実行してください。
> 🛑 マークがある箇所は、人間の操作や確認が必要なタイミングです。必ず作業を中断し、ユーザーに指示を仰いでください。

# LINE audiomemo ユーザー体験 (UX) 設計書

本ドキュメントでは、ユーザーが「LINE audiomemo」を初めて利用する際のオンボーディングフローおよび、各プラットフォーム連携時のユーザーインタラクションについて定義します。

## 1. オンボーディングフロー（初回登録時）

### フロー概要
1.  **友だち追加**: ユーザーが LINE 公式アカウントを友だち追加。
2.  **Welcome Flex Message 送信**: サービス概要と連携先選択を含むリッチなメッセージを自動送信。
3.  **連携先選択**: ユーザーが連携したいプラットフォームを選択。
4.  **詳細ガイド**: 選択されたプラットフォームに応じたセットアップ手順を提示。

### Welcome Flex Message 構成案
- **ヘッダー**: 「LINE audiomemo へようこそ！」
- **メイン画像**: 音声がAIによって整理されるイメージ図。
- **ボディ**: 
    - 「あなたの思考整理パートナーです。」
    - 「まずは、**どのように使いたいか**教えてください👇」
- **利用モード選択（カルーセルまたはボタン）**:
    - **日記モード**: 1日の振り返りを感情とともに整理。
    - **TODO抽出**: すべきことを明確にリスト化。
    - **気づき・メモ**: ふとしたアイデアを忘れないうちに記録。
    - **アイデア壁打ち**: 思考を構造化し、深めるための「問い」を提案。
- **フッター**:
    - モード選択後に連携先設定（Obsidian/Webhook）へ誘導します。

---

## 2. プラットフォーム別連携フロー

### A. Obsidian 連携フロー (Setup Obsidian)
モード選択後、またはメニューから **[Obsidian と連携]** を選択した場合：

1.  **User ID 提示メッセージ**:
    - ボットが以下の情報を返信します。
        > **Step 1: Obsidianプラグインをインストール**
        > 「LINE audiomemo」プラグインをObsidianに入れ、設定画面を開いてください。
        >
        > **Step 2: User ID を登録**
        > 以下の ID をコピーして、プラグイン設定の「LINE User ID」欄に貼り付けてください。
    - **ID表示**: ユーザーの `userId` をクリックでコピー可能な形式で表示（Flex Message の `action: copy` を利用）。

2.  **Obsidian側での操作**:
    - ユーザーが ID をプラグインに入力し「Connect」ボタンを押す。
    - プラグインがサーバーへ `GET /mapping/register` をリクエスト。
    - 成功すると「連携が完了しました！」と表示。

3.  **完了通知 (LINE)**:
    - サーバーが連携完了を検知し、LINEでプッシュ通知。
        > 「🎉 連携完了！音声を送ってみてください。」

### B. Webhook (n8n/Make等) 連携フロー
ユーザーが **[Webhook と連携]** をタップした場合：

1.  **設定ガイドメッセージ**:
    - 「n8n や Make 等の Webhook URL を設定してください。要約結果を JSON 形式で送信します。」
    - `/webhook <URL>` という形式で入力を促す。

2.  **URL登録**:
    - ユーザーが URL を送信。
    - ボットが疎通テスト用メッセージをテスト送信し、成功すれば登録完了。

3.  **完了通知 (LINE)**:
    - 「🎉 Webhook連携が完了しました！これで n8n 等にデータを飛ばせます。」

---

## 3. 日常利用時のUX

### 3.1 音声送信・要約フロー（事前確認あり）
連携先は初期設定で選択された1つ（ObsidianまたはSlack）に固定されます。
デフォルトでは、送信した音声の要約結果をユーザーが確認してから当該プラットフォームへ配信します。

1.  **音声送信**: ユーザーがボイスメッセージを送信。
2.  **解析中**: LINEのLoading Animationを表示。
3.  **要約提示（確認モード時）**:
    - AIが作成した要約テキストを Flex Message で提示。
    - **アクションボタン**:
        - [🚀 送信する]: 連携済みの対象（Obsidian/Slack等）へ即座に配信。
        - [🗑️ キャンセル]: 今回の入力を破棄。
4.  **配信完了**:
    - ユーザーが [送信する] を選択後、最終的な完了通知を表示。
    - **Obsidian連携**: 「✅ Obsidian(vault: Personal)に保存しました」
    - **Webhook連携**: 「✅ Webhook(n8n等)に送信しました」

---

## 4. コマンド操作と設定

ユーザーはテキスト入力欄からスラッシュコマンドを送ることで、設定の変更や情報の取得が可能です。「ヘルプ」や「コマンド」と入力すると、利用可能なコマンドリストが返信されます。

### 4.1 コマンドリスト
ボットに特定のキーワード（設定、メニュー、コマンド、help等）を送ると、以下のコマンド一覧がMessageで表示されます。

- **`/id`**: 自分の LINE User ID を表示（コピー用）。
- **`/prompt`**: 現在のAIプロンプトを確認・編集（カスタム設定）。
- **`/confirm`**: 事前確認モードの設定。ON/OFF を切り替えられます。
- **`/vault`**: 現在アクティブな送信先 Vault の確認・切り替え。
- **`/webhook`**: Webhook URL の確認・設定。
- **`/status`**: 現在の各プラットフォーム（Obsidian/Webhook）の連携状況を表示。

### 4.2 コマンド実行のUX
- **`/id`**:
    - 「あなたの ID は `U1234...` です（タップしてコピー）」というバブルを送信。
- **`/prompt`**:
    - **Bot**: 現在の設定内容を表示。
        > 「現在のモード: **日記モード**
        >
        > **現在のプロンプト内容**:
        > 『あなたはユーザーの親しい友人です。入力された音声から、出来事と感情を抽出して日記形式でまとめてください...』
        >
        > ✏️ **カスタマイズ**:
        > この内容を書き換えたい場合は、**新しいプロンプトをこのまま返信**してください。
        > 標準モードに戻す場合は「リセット」と送信してください。」
    - **User**: 「あなたは関西弁の...」と返信。
    - **Bot**: 「✅ カスタムプロンプトを設定しました。」
- **`/confirm`**:
    - **機能説明**: 音声の要約後、すぐに配信せず、内容を確認・修正してから送信できるモードです。
    - **現在の状態提示**: 「現在の設定: **ON (確認してから送信)**」
    - **アクションボタン**: [確認を OFF にする (自動配信)] / [今のまま (ON) にする]
    - **切り替え後の通知**: 「✅ 設定を更新しました。次回から要約完了後に即座に配信されます。」

---

### コマンド操作（リッチメニュー）
- **左下**: **[マイク]** (音声入力モードへの誘導、またはタップで録音開始 ※LINE仕様による)
- **右下**: **[設定・連携確認]**
    - 現在の連携状態（Active Vaultなど）を表示。
    - `help`を表示。
